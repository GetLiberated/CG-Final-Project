<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Car Simulator</title>

    <!-- Babylon.js -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>

    <!-- Local js -->
    <script src="./javascript/physics.js"></script>
    <script src="./javascript/car.js"></script>
    <script src="./javascript/map.js"></script>
    <script src="./javascript/animation.js"></script>
    <script src="./javascript/shader.js"></script>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false});

        var createScene = function () {
                            var scene = new BABYLON.Scene(engine);

                            // enable physics
                            scene.enablePhysics(new BABYLON.Vector3(0, -32, 0), new BABYLON.OimoJSPlugin());

                            // camera
                            var camera = new BABYLON.ArcRotateCamera("camera1", 0, 0, 20, new BABYLON.Vector3(0, 0, 0), scene);
                            camera.setPosition(new BABYLON.Vector3(25, 10, 0));
                            camera.attachControl(canvas, true)
                            camera.inputs.attached.pointers.buttons = [0] // disable right mouse button drag
                            camera.lowerRadiusLimit = 20 // limit zoom in scroll
                            camera.upperRadiusLimit = 40 // limit zoom out scroll
                            var cameraStartAlpha = camera.alpha
                            var cameraStartBeta = camera.beta
                            var cameraStartRadius = camera.radius
                            camera.checkCollisions = true;

                            // fps camera
                            var camera2 = new BABYLON.UniversalCamera("camera2", new BABYLON.Vector3(0, 0, 0), scene);
                            camera2.position = new BABYLON.Vector3(0.2, 4.5, 1);
                            camera2.rotation = new BABYLON.Vector3(0, 4.68, 0);

                            // lights
                            var light1 = new BABYLON.DirectionalLight("light1", new BABYLON.Vector3(1, 2, 0), scene);
                            var light2 = new BABYLON.HemisphericLight("light2", new BABYLON.Vector3(0, 1, 0), scene);
                            light2.intensity = 0.75;

                            // glow layer
                            var gl = new BABYLON.GlowLayer("glow", scene, {
                                mainTextureFixedSize: 1024,
                                blurKernelSize: 64
                            });

                            // car
                            var car = createCar(scene)
                            camera.parent = car;
                            camera2.parent = car
                            var carStartRotation = car.rotationQuaternion.clone();
                            importCarModel(scene, car)

                            // map
                            createMap(scene, car, fail, lose)

                            /*****************************GUI********************************************/

                            var gui = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                            // goal
                            var rect1 = new BABYLON.GUI.Rectangle();
                            rect1.width = "80px";
                            rect1.height = "40px";
                            rect1.cornerRadius = 20;
                            rect1.color = "orange";
                            rect1.thickness = 4;
                            rect1.background = "orange";
                            gui.addControl(rect1);
                            rect1.linkOffsetY = -150;

                            var label = new BABYLON.GUI.TextBlock();
                            label.text = "Goal";
                            label.color = "white"
                            rect1.addControl(label);

                            var target = new BABYLON.GUI.Ellipse();
                            target.width = "30px";
                            target.height = "30px";
                            target.color = "orange";
                            target.thickness = 4;
                            target.background = "orange";
                            gui.addControl(target);

                            var line = new BABYLON.GUI.Line();
                            line.lineWidth = 4;
                            line.color = "orange";
                            line.y2 = 10;
                            line.linkOffsetY = -10;
                            gui.addControl(line);
                            line.connectedControl = rect1;

                            // objective
                            var rect = new BABYLON.GUI.Rectangle();
                            rect.width = "400px";
                            rect.height = "150px";
                            rect.cornerRadius = 20;
                            rect.background = "black";
                            rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                            rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                            rect.paddingTop = "10px"
                            rect.paddingLeft = "10px"
                            rect.alpha = 0.6
                            gui.addControl(rect);

                            var objective_text = new BABYLON.GUI.TextBlock();
                            objective_text.text = "Objective";
                            objective_text.color = "white";
                            objective_text.fontSize = 36;
                            objective_text.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                            objective_text.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                            objective_text.paddingTop = "16px"
                            objective_text.paddingLeft = "20px"
                            gui.addControl(objective_text);

                            var task_text = new BABYLON.GUI.TextBlock();
                            task_text.text = "Blink right before perempatan";
                            task_text.color = "white";
                            task_text.fontSize = 24;
                            task_text.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                            task_text.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                            task_text.top = 80
                            task_text.left = 20
                            gui.addControl(task_text);

                            var task2_text = new BABYLON.GUI.TextBlock();
                            task2_text.text = "Reach goal";
                            task2_text.color = "white";
                            task2_text.fontSize = 24;
                            task2_text.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                            task2_text.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                            task2_text.top = 110
                            task2_text.left = 20
                            gui.addControl(task2_text);

                            // overlay
                            var dark_overlay = new BABYLON.GUI.Image("", "./assets/black.png");
                            dark_overlay.alpha = 0.5
                            dark_overlay.isVisible = false
                            gui.addControl(dark_overlay);

                            // win screen
                            var check = new BABYLON.GUI.Image("", "./assets/check.png");
                            check.isVisible = false
                            check.stretch = BABYLON.GUI.Image.STRETCH_UNIFORM
                            check.width = 0.2
                            check.height = 0.2
                            gui.addControl(check);

                            // lose screen
                            var text1 = new BABYLON.GUI.TextBlock();
                            text1.text = "You failed";
                            text1.color = "white";
                            text1.fontSize = 80;
                            text1.top = "-100px"
                            text1.isVisible = false
                            gui.addControl(text1);

                            var button = BABYLON.GUI.Button.CreateSimpleButton("", "Retry");
                            button.width = 0.2;
                            button.height = "40px";
                            button.color = "white";
                            button.background = "red";
                            button.isVisible = false
                            button.onPointerClickObservable.add(function () {
                                dark_overlay.isVisible = false
                                text1.isVisible = false
                                button.isVisible = false
                                window.clearTimeout(stopCarPhysicsTimeout)
                                restart()
                            });
                            gui.addControl(button);

                            /*****************************End GUI********************************************/

                            /*****************************Animations********************************************/

                            var cutscene = 0
                            var camera3 = new BABYLON.UniversalCamera("camera3", new BABYLON.Vector3(0, 0, 0), scene);
                            var frameRate = 20
                            var flip = false

                            // Win Cutscene

                            function winCutscene() {
                                dark_overlay.alpha = 0
                                dark_overlay.isVisible = true
                                check.alpha = 0
                                check.isVisible = true

                                var [fadeout, blink] = winAnimation(frameRate)

                                scene.beginDirectAnimation(dark_overlay, [fadeout], 0, 25 * frameRate, false);
                                scene.beginDirectAnimation(check, [blink], 0, 25 * frameRate, false);
                            }

                            // Cutscene 1

                            function cutscene1() {
                                cutscene = 1
                                activeCamera = 3
                                scene.activeCamera = camera3
                                car.physicsImpostor.dispose()
                                dark_overlay.alpha = 0
                                dark_overlay.isVisible = true

                                var [camera_rotate, camera_position, car_move, fadeout] = cutscene1Animation(frameRate)

                                scene.beginDirectAnimation(camera3, [camera_position, camera_rotate], 0, 25 * frameRate, false);
                                scene.beginDirectAnimation(car, [car_move], 0, 25 * frameRate, false);
                                scene.beginDirectAnimation(dark_overlay, [fadeout], 0, 25 * frameRate, false);
                            }

                            function cutscene1Logic() {
                                if (camera3.position.x > -108) {
                                    mf = true
                                }
                                if (camera3.position.x === -108 && !flip) {
                                    mf = false
                                    car.physicsImpostor = new BABYLON.PhysicsImpostor(car, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, friction: 0.4, restitution: 0.8 }, scene);
                                    car.physicsImpostor.dispose()
                                    setTimeout(function () {
                                        blinkRight()
                                    }, 300)
                                    flip = true
                                }
                                if (camera3.position.x === -120 && flip) {
                                    setTimeout(function () {
                                        blinkRight()
                                        car.physicsImpostor = new BABYLON.PhysicsImpostor(car, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, friction: 0.4, restitution: 0.8 }, scene);
                                        rr = true
                                        setTimeout(function () {
                                            rr = false
                                        }, 100)
                                        setTimeout(function () {
                                            mf = true
                                            setTimeout(function () {
                                                cutscene = 0
                                                activeCamera = 2
                                                changeCamera()
                                                dark_overlay.alpha = 0.5
                                                dark_overlay.isVisible = false
                                                mapMeshes.forEach((mesh, index) => {
                                                    car.physicsImpostor.registerOnPhysicsCollide(mesh.physicsImpostor, function (main, collided) {
                                                        if (!fail) {
                                                            lose()
                                                        }
                                                    });
                                                });
                                                car.physicsImpostor.registerOnPhysicsCollide(goal.physicsImpostor, function (main, collided) {
                                                    if (!fail) {
                                                        task2_text.color = "green"
                                                        win()
                                                    }
                                                });
                                                restart()
                                            }, 3000)
                                        }, 1000)
                                    }, 800)
                                    flip = false
                                }
                            }

                            cutscene1()

                            // Cutscene 2

                            function cutscene2() {
                                cutscene = 2
                                activeCamera = 3
                                camera3.attachControl(scene, false)
                                scene.activeCamera = camera3
                                car.physicsImpostor.dispose()
                                dark_overlay.alpha = 0
                                dark_overlay.isVisible = true

                                var [camera_rotate, camera_position, car_move, fadeout] = cutscene1Animation(frameRate)

                                scene.beginDirectAnimation(camera3, [camera_position, camera_rotate], 0, 25 * frameRate, false);
                                scene.beginDirectAnimation(car, [car_move], 0, 25 * frameRate, false);
                                scene.beginDirectAnimation(dark_overlay, [fadeout], 0, 25 * frameRate, false);
                            }

                            /********************************************End Animations********************************************/

                            /********************************************Gameplay********************************************/

                            var fail = false
                            var success = false
                            var level = 1
                            var stopCarPhysicsTimeout;

                            function stopCarPhysics() {
                                mf = false;
                                mb = false;
                                rl = false;
                                rr = false;
                                car.physicsImpostor.setLinearVelocity(
                                    new BABYLON.Vector3(0, 0, 0)
                                );
                                car.physicsImpostor.setAngularVelocity(
                                    new BABYLON.Vector3(0, 0, 0)
                                );
                            }

                            function restart() {
                                stopCarPhysics()

                                // reset car position and rotation
                                car.position = new BABYLON.Vector3.Zero()
                                car.rotationQuaternion = carStartRotation.clone();
                                carWheels[0].rotation.y = 0
                                carWheels[1].rotation.y = Math.PI
                                carSteeringWheel.rotation.x = -0.15
                                if (right_indicator_turned_on)
                                blinkRight()
                                if (left_indicator_turned_on)
                                blinkLeft()

                                // reset camera
                                camera.alpha = cameraStartAlpha;
                                camera.beta = cameraStartBeta;
                                camera.radius = cameraStartRadius
                                camera.attachControl(canvas, true)
                                camera.parent = car

                                fail = false
                            }

                            // called when player completed all the objectives
                            function win() { 
                                success = true
                                winCutscene()
                                setTimeout(function () {
                                    switch (level) {
                                        case 1:
                                            success = false
                                            cutscene2()
                                        break
                                    }
                                }, 1000)
                            }

                            // called when player failed to complete the objectives
                            function lose() { 
                                // show lose screen
                                dark_overlay.isVisible = true
                                text1.isVisible = true
                                button.isVisible = true

                                camera.detachControl(canvas)
                                camera.parent = null
                                stopCarPhysicsTimeout = setTimeout(stopCarPhysics, 1000)
                                fail = true
                            }

                            /*****************************Level 1**********************************************/

                            // create goal
                            var goal = BABYLON.MeshBuilder.CreateCylinder("goal", { height: 20, diameter: 8 });
                            goal.position = new BABYLON.Vector3(-144, 2, 46);

                            // create material for goal
                            var mat = new BABYLON.StandardMaterial()
                            goal.material = mat
                            goal.material.diffuseColor = BABYLON.Color3.Yellow()
                            // goal.material.emissiveColor = BABYLON.Color3.Yellow()
                            goal.material.alpha = 0.7

                            // add physics to goal for collision detection
                            goal.physicsImpostor = new BABYLON.PhysicsImpostor(goal, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0 }, scene);

                            // attach goal gui to goal
                            rect1.linkWithMesh(goal);
                            line.linkWithMesh(goal);
                            target.linkWithMesh(goal);

                            function level1(right_indicator_turned_on) {
                                if (car.position.z < -30) {
                                    task_text.color = "white"
                                    lose()
                                }
                                if (car.position.x < -90 && task_text.color !== "green") {
                                    lose()
                                }
                                else if (right_indicator_turned_on) {
                                    task_text.color = "green"
                                    if (fail) {
                                        task_text.color = "white"
                                        blinkRight()
                                    }
                                }
                            }

                            /*****************************End Level 1**********************************************/

                            /********************************************End Gameplay********************************************/

                            /*****************************Input********************************************/

                            var mf = false; // move forward
                            var mb = false; // move backward
                            var rl = false; // rotate left
                            var rr = false; // rotate right
                            var brake = false

                            var activeCamera = 1

                            function changeCamera() {
                                if (activeCamera === 1) {
                                    activeCamera = 2;
                                    camera.detachControl(canvas);
                                }
                                else if (activeCamera === 2) {
                                    activeCamera = 1;
                                    camera2.detachControl(canvas);
                                }
                                scene.activeCamera = activeCamera === 1 ? camera : camera2;
                                activeCamera === 1 && camera.attachControl(canvas, false)
                            }

                            window.addEventListener('keydown', function (e) {
                                if (cutscene < 1 && !fail && !success) {
                                    switch (e.keyCode) {
                                        case 87://w
                                            mf = true;
                                            break;
                                        case 83://s
                                            mb = true;
                                            break;
                                        case 65://a
                                            rl = true;
                                            break;
                                        case 68://d
                                            rr = true;
                                            break;
                                        case 32://space
                                            brake = true
                                            var mat = new BABYLON.StandardMaterial('', scene)
                                            mat.diffuseColor = BABYLON.Color3.Red()
                                            mat.emissiveColor = BABYLON.Color3.Red()
                                            carLights[1][0].material = carLights[0][0].material = mat
                                            break;
                                        case 82://r
                                            restart()
                                            break;
                                        case 81://q
                                            blinkLeft()
                                            break;
                                        case 69://e
                                            blinkRight()
                                            break;
                                        case 86://v
                                            changeCamera()
                                            break;
                                    }
                                }
                            });

                            window.addEventListener('keyup', function (e) {
                                if (cutscene < 1 && !fail && !success) {
                                    switch (e.keyCode) {
                                        case 87://w
                                            mf = false;
                                            break;
                                        case 83://s
                                            mb = false;
                                            break;
                                        case 65://a
                                            rl = false;
                                            break;
                                        case 68://d
                                            rr = false;
                                            break;
                                        case 32://space
                                            brake = false
                                            carLights[1][0].material = carLights[0][0].material = carLightStartMaterial
                                            break;
                                        case 82://r
                                            break;
                                        case 81://q
                                            break;
                                        case 69://e
                                            break;
                                        case 86://v
                                            break;
                                    }
                                }
                            });

                            /*****************************End Input********************************************/

                            function update() { // function for codes that needs constant loop

                                // console.log(car.position)
                                // console.log(car.physicsImpostor.getLinearVelocity())

                                // input
                                // add thrust to car physics
                                if (mf == true) {
                                    translate(car, new BABYLON.Vector3(-1, 0, 0), 1);
                                    // if (car.physicsImpostor.getLinearVelocity().x < -maxSpeed) {}
                                    // else car.physicsImpostor.applyImpulse(new BABYLON.Vector3(-1, 0, 0).scale(1), car.getAbsolutePosition().add(BABYLON.Vector3.Zero()));

                                    if (carWheels[0].rotation.y < -0.05)
                                        rotate(car, new BABYLON.Vector3(0, -1, 0), -carWheels[0].rotation.y / 4);
                                    // car.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, 1).scale(0.1), car.getAbsolutePosition());
                                    if (carWheels[0].rotation.y > 0.05)
                                        rotate(car, new BABYLON.Vector3(0, 1, 0), carWheels[0].rotation.y / 4);
                                    // car.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, -1).scale(1), car.getAbsolutePosition());
                                }
                                if (mb == true) {
                                    translate(car, new BABYLON.Vector3(1, 0, 0), 1);
                                    if (carWheels[0].rotation.y < -0.05)
                                        rotate(car, new BABYLON.Vector3(0, 1, 0), -carWheels[0].rotation.y / 4);
                                    if (carWheels[0].rotation.y > 0.05)
                                        rotate(car, new BABYLON.Vector3(0, -1, 0), carWheels[0].rotation.y / 4);
                                }
                                if (rl == true) {
                                    if (carWheels[0].rotation.y < -0.5) {
                                    }
                                    else {
                                        carWheels[0].rotation.y += -0.05
                                        carWheels[1].rotation.y += -0.05
                                        carSteeringWheel.rotation.x += -0.05
                                    }
                                }
                                if (rr == true) {
                                    if (carWheels[0].rotation.y > 0.5) {
                                    }
                                    else {
                                        carWheels[0].rotation.y += 0.05
                                        carWheels[1].rotation.y += 0.05
                                        carSteeringWheel.rotation.x += 0.05
                                    }
                                }
                                if (brake == true) {
                                    if (car.physicsImpostor.getLinearVelocity().x < -0.5)
                                        translate(car, new BABYLON.Vector3(-1, 0, 0), -1);
                                    else if (car.physicsImpostor.getLinearVelocity().x > 0.5)
                                        translate(car, new BABYLON.Vector3(1, 0, 0), -1);
                                    else {
                                        car.physicsImpostor.setLinearVelocity(
                                            new BABYLON.Vector3.Zero()
                                        );
                                    }
                                }

                                // car wheel rotation physics
                                if (car.physicsImpostor.getLinearVelocity().x < -0.1 || car.physicsImpostor.getLinearVelocity().x > 0.1) {
                                    carWheels.forEach((mesh, index) => {
                                        if (index % 2)
                                            mesh.rotation.z += car.physicsImpostor.getLinearVelocity().x / 16
                                        else
                                            mesh.rotation.z -= car.physicsImpostor.getLinearVelocity().x / 16
                                    })
                                }

                                // cutscene
                                switch (cutscene) {
                                    case 0:
                                        // level
                                        switch (level) {
                                            case 1:
                                                level1(right_indicator_turned_on)
                                                break
                                        }
                                    case 1:
                                        cutscene1Logic()
                                        break
                                }
                            }

                            // show inspector
                            // scene.debugLayer.show({embedMode: true});
                            
                            // display loading screen while loading assets
                            engine.displayLoadingUI();

                            scene.registerBeforeRender(function () {
                                update();
                            })

                            return scene;
        }

        var scene = createScene();

        // Wait for textures and shaders to be ready
        scene.executeWhenReady(function () {
            engine.hideLoadingUI();

            // Once the scene is loaded, just register a render loop to render it
            engine.runRenderLoop(function () {
                scene.render();
            });

            // Resize canvas if window is resized
            window.addEventListener("resize", () => {
                engine.resize()
            })
        });

        // var nodeMaterial = new BABYLON.NodeMaterial("nodeMat", scene, {
            //     emitComments: true
            // });
            // nodeMaterial.loadAsync("https://gist.githubusercontent.com/dannybucksch/8c1e194a526b8420039481dceb77995d/raw/e75f2d3bbda4ea2528d2995c613bec50595cdf4e/mouse_sine.json").then(() => {
            //     nodeMaterial.build(true);
            //     nodeMaterial.needDepthPrePass = true;
            //     nodeMaterial.backFaceCulling = false;

            //     goal.material = nodeMaterial;
            // })
    </script>
</body>

</html>